@page "/inventory"
@using System.Text.Json
@inject IJSRuntime JS

@* <h3>Inventory Table</h3>
<div id="inventoryTable"></div>
<br/> *@
<h3>Editable Table</h3>
<div style="max-width:100%; overflow-x:auto;">
    <div id="editableTable"></div>
</div>

<br/>
<div>
    <button class="btn btn-primary" @onclick="SaveData" disabled="@isSaving">
        @if (isSaving)
        {
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            <span class="ms-2">Saving...</span>
        }
        else
        {
            <span>Save</span>
        }
    </button>
</div>

@if (!string.IsNullOrEmpty(statusMessage))
{
    <div class="mt-3">
        <div class="alert @alertClass" role="alert">
            @statusMessage
        </div>
    </div>
}

@code {
    private bool isSaving = false;
    private string statusMessage = string.Empty;
    private string alertClass = "alert-success"; // немесе "alert-danger"

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("editTableInterop.editableTable", "editableTable", "/data/data2.json");
        }
    }
    private async Task SaveData()
    {
        isSaving = true;
        statusMessage = string.Empty;

        try
        {
            var json = await JS.InvokeAsync<string>("editTableInterop.getData");
            // Десериализация
            var deserializeOptions = new JsonSerializerOptions
            {
                PropertyNameCaseInsensitive = true                
            };
            var rows = JsonSerializer.Deserialize<List<MyRowModel>>(json, deserializeOptions);
            //Сериализация қайтадан
            var serializeOptions = new JsonSerializerOptions
            {
                PropertyNamingPolicy = JsonNamingPolicy.CamelCase,
                WriteIndented = true
            };            
            var outJson = System.Text.Json.JsonSerializer.Serialize(rows, serializeOptions);

            var path = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot/data/data2.json");
            await File.WriteAllTextAsync(path, outJson);

            // Success статусын көрсету
            alertClass = "alert-success";
            statusMessage = $"Saved {rows.Count} rows successfully.";
        }
        catch (JSException jsEx)
        {
            alertClass = "alert-danger";
            Console.WriteLine("JSInterop error: " + jsEx.Message);
        }
        catch (Exception ex)
        {
            alertClass = "alert-danger";
            Console.WriteLine("General error: " + ex.Message);
        }
        finally
        {
            isSaving = false;
            // Хабарды автоматты түрде 5 секундтан кейін жасыру
            _ = Task.Run(async () =>
            {
                await Task.Delay(5000);
                statusMessage = string.Empty;
                StateHasChanged();
            });
        }

       
    }

    public class MyRowModel
    {
        public string Name { get; set; }
        public string Location { get; set; }
        public int Progress { get; set; }
        public string Gender { get; set; }
        public int Rating { get; set; }
        public string Dob { get; set; }
        public bool Car { get; set; }
    }
}
